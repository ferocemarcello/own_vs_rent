<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buy vs. Rent Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Ensure inputs are visible in dark mode */
        input[type="number"] {
            @apply text-white;
        }
    </style>
    <script>
        // Set up Tailwind dark mode
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        }
    </script>
</head>
<body class="bg-gray-900 text-gray-200 font-sans antialiased p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <h1 class="text-3xl font-bold text-center text-white mb-8">Buy vs. Rent Calculator</h1>

        <div class="bg-gray-800 p-6 rounded-xl shadow-lg mb-8 max-w-2xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <label for="analysis-period" class="block text-lg font-semibold text-white">Analysis Period (Years)</label>
                <input type="number" id="analysis-period" value="30" class="w-full mt-2 bg-gray-700 border border-gray-600 rounded-md p-3 focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div>
                <label for="inflation" class="block text-lg font-semibold text-white">Yearly Inflation (%)</label>
                <input type="number" id="inflation" value="3.0" class="w-full mt-2 bg-gray-700 border border-gray-600 rounded-md p-3 focus:ring-blue-500 focus:border-blue-500">
            </div>
        </div>

        <div>
            <div id="international-version">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    
                    <div class="bg-gray-800 p-6 rounded-xl shadow-lg space-y-4">
                        <h2 class="text-2xl font-semibold text-white border-b border-gray-700 pb-3">Purchase Inputs</h2>
                        
                        <div>
                            <label for="int-home-price" class="block text-sm font-medium text-gray-300">Home Initial Price</label>
                            <input type="number" id="int-home-price" value="300000" class="mt-1 w-full bg-gray-700 border-gray-600 rounded-md p-2">
                        </div>

                        <div>
                            <label for="int-initial-costs-pct" class="block text-sm font-medium text-gray-300">Initial Costs (% of Home Price)</label>
                            <input type="number" id="int-initial-costs-pct" value="2.5" class="mt-1 w-full bg-gray-700 border-gray-600 rounded-md p-2">
                        </div>
                        
                        <div>
                            <label for="int-initial-costs-abs" class="block text-sm font-medium text-gray-300">Initial Costs (Absolute)</label>
                            <input type="number" id="int-initial-costs-abs" value="2000" class="mt-1 w-full bg-gray-700 border-gray-600 rounded-md p-2">
                        </div>

                        <div>
                            <label for="int-fixed-term-abs" class="block text-sm font-medium text-gray-300">Yearly Expenses with Fixed Term (Absolute)(e.g. mortgage)</label>
                            <input type="number" id="int-fixed-term-abs" value="20000" class="mt-1 w-full bg-gray-700 border-gray-600 rounded-md p-2">
                        </div>

                        <div>
                            <label for="int-fixed-term-years" class="block text-sm font-medium text-gray-300">Years for Fixed Term Expenses(e.g. mortgage duration)</label>
                            <input type="number" id="int-fixed-term-years" value="10" class="mt-1 w-full bg-gray-700 border-gray-600 rounded-md p-2">
                        </div>
                        
                        <div>
                            <label for="int-purchase-yearly-deposit" class="block text-sm font-medium text-gray-300">Yearly Deposit during fixed term</label>
                            <input type="number" id="int-purchase-yearly-deposit" value="0" class="mt-1 w-full bg-gray-700 border-gray-600 rounded-md p-2">
                        </div>

                        <div>
                            <label for="int-purchase-yearly-deposit-increase" class="block text-sm font-medium text-gray-300">Yearly Deposit Increase (%/year)</label>
                            <input type="number" id="int-purchase-yearly-deposit-increase" value="3" class="mt-1 w-full bg-gray-700 border-gray-600 rounded-md p-2">
                        </div>

                        <div>
                            <label for="int-other-yearly-abs" class="block text-sm font-medium text-gray-300">Additional Yearly Expenses (Absolute)</label>
                            <input type="number" id="int-other-yearly-abs" value="5000" class="mt-1 w-full bg-gray-700 border-gray-600 rounded-md p-2">
                        </div>

                        <div>
                            <label for="int-other-yearly-pct" class="block text-sm font-medium text-gray-300">Other Yearly Expenses (% of Home Value)</label>
                            <input type="number" id="int-other-yearly-pct" value="0" class="mt-1 w-full bg-gray-700 border-gray-600 rounded-md p-2">
                        </div>

                        <div>
                            <label for="int-home-appreciation" class="block text-sm font-medium text-gray-300">Home Yearly Appreciation (%)</label>
                            <input type="number" id="int-home-appreciation" value="4.0" class="mt-1 w-full bg-gray-700 border-gray-600 rounded-md p-2">
                        </div>
                        
                        <div>
                            <label for="int-end-term-pct" class="block text-sm font-medium text-gray-300">Expenses at End of Term (% of Price)</label>
                            <input type="number" id="int-end-term-pct" value="0" class="mt-1 w-full bg-gray-700 border-gray-600 rounded-md p-2">
                        </div>

                        <div>
                            <label for="int-end-term-abs" class="block text-sm font-medium text-gray-300">Expenses at End of Term (Absolute)</label>
                            <input type="number" id="int-end-term-abs" value="0" class="mt-1 w-full bg-gray-700 border-gray-600 rounded-md p-2">
                        </div>
                        
                        <div>
                            <label for="int-selling-costs-pct" class="block text-sm font-medium text-gray-300">Selling Costs (% of Final Price)</label>
                            <input type="number" id="int-selling-costs-pct" value="2.0" class="mt-1 w-full bg-gray-700 border-gray-600 rounded-md p-2">
                        </div>
                        
                        <div>
                            <label for="int-purchase-yearly-investment-after" class="block text-sm font-medium text-gray-300">Yearly Deposit after fixed term</label>
                            <input type="number" id="int-purchase-yearly-investment-after" value="30700" class="mt-1 w-full bg-gray-700 border-gray-600 rounded-md p-2">
                        </div>
                    </div>

                    <div class="bg-gray-800 p-6 rounded-xl shadow-lg space-y-4">
                        <h2 class="text-2xl font-semibold text-white border-b border-gray-700 pb-3">Rental Inputs</h2>
                        
                        <div>
                            <label for="int-yearly-rent" class="block text-sm font-medium text-gray-300">Yearly Rent (Absolute)</Tabel>
                            <input type="number" id="int-yearly-rent" value="7795" class="mt-1 w-full bg-gray-700 border-gray-600 rounded-md p-2">
                        </div>

                        <div>
                            <label for="int-rent-increase" class="block text-sm font-medium text-gray-300">Rent Increase (%/year)</label>
                            <input type="number" id="int-rent-increase" value="3.0" class="mt-1 w-full bg-gray-700 border-gray-600 rounded-md p-2">
                        </div>

                        <div>
                            <label for="int-rent-additional-yearly-abs" class="block text-sm font-medium text-gray-300">Additional Yearly Expenses (Absolute)</label>
                            <input type="number" id="int-rent-additional-yearly-abs" value="150" class="mt-1 w-full bg-gray-700 border-gray-600 rounded-md p-2">
                        </div>

                        <div>
                            <label for="int-rental-yearly-deposit" class="block text-sm font-medium text-gray-300">Yearly Deposit</label>
                            <input type="number" id="int-rental-yearly-deposit" value="25000" class="mt-1 w-full bg-gray-700 border-gray-600 rounded-md p-2">
                        </div>

                        <div>
                            <label for="int-rental-yearly-deposit-increase" class="block text-sm font-medium text-gray-300">Yearly Deposit Increase (%/year)</label>
                            <input type="number" id="int-rental-yearly-deposit-increase" value="3" class="mt-1 w-full bg-gray-700 border-gray-600 rounded-md p-2">
                        </div>
                    </div>

                    <div class="bg-gray-800 p-6 rounded-xl shadow-lg space-y-4">
                        <h2 class="text-2xl font-semibold text-white border-b border-gray-700 pb-3">Investment Inputs</h2>

                        <div>
                            <label for="int-initial-deposit-buyer" class="block text-sm font-medium text-gray-300">Initial Deposit (for Buyer)</label>
                            <input type="number" id="int-initial-deposit-buyer" value="0" class="mt-1 w-full bg-gray-700 border-gray-600 rounded-md p-2">
                        </div>

                        <div>
                            <label for="int-initial-deposit-renter" class="block text-sm font-medium text-gray-300">Initial Deposit (for Renter)</label>
                            <input type="number" id="int-initial-deposit-renter" value="53000" class="mt-1 w-full bg-gray-700 border-gray-600 rounded-md p-2">
                        </div>
                        
                        <div>
                            <label for="int-investment-return" class="block text-sm font-medium text-gray-300">Investment Return (%/year)</label>
                            <input type="number" id="int-investment-return" value="10" class="mt-1 w-full bg-gray-700 border-gray-600 rounded-md p-2">
                        </div>

                        <div>
                            <label for="int-cap-gains-tax" class="block text-sm font-medium text-gray-300">Capital Gains Tax (%)</label>
                            <input type="number" id="int-cap-gains-tax" value="25.0" class="mt-1 w-full bg-gray-700 border-gray-600 rounded-md p-2">
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <div class="text-center mt-8">
            <button id="calculate-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg text-lg transition duration-300 shadow-lg">
                Calculate
            </button>
        </div>

        <div id="results-section" class="mt-10 bg-gray-800 p-6 rounded-xl shadow-lg hidden">
            <h2 class="text-2xl font-semibold text-white mb-6 text-center">Results after <span id="results-years">10</span> Years</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center mb-8">
                <div>
                    <div class="text-sm text-gray-400">Owner's Net Worth</div>
                    <div id="owner-net-worth" class="text-3xl font-bold text-cyan-400"></div>
                </div>
                <div>
                    <div class="text-sm text-gray-400">Renter's Net Worth</div>
                    <div id="renter-net-worth" class="text-3xl font-bold text-lime-400"></div>
                </div>
                <div>
                    <div class="text-sm text-gray-400">Net Benefit of <span id="winner"></span></div>
                    <div id="net-benefit" class="text-3xl font-bold text-white"></div>
                </div>
            </div>

            <div>
                <canvas id="comparison-chart"></canvas>
            </div>

            <div class="mt-10 overflow-x-auto">
                <h3 class="text-xl font-semibold text-white mb-4 text-center">Year-by-Year Breakdown</h3>
                <div id="results-table-container">
                    </div>
            </div>
        </div>
    </div>

    <script>
        // --- DOM Element References ---
        const calculateBtn = document.getElementById('calculate-btn');
        const resultsSection = document.getElementById('results-section');
        const chartCanvas = document.getElementById('comparison-chart');
        
        const resultsYears = document.getElementById('results-years');
        const ownerNetWorthEl = document.getElementById('owner-net-worth');
        const renterNetWorthEl = document.getElementById('renter-net-worth');
        const winnerEl = document.getElementById('winner');
        const netBenefitEl = document.getElementById('net-benefit');

        let myChart; // To hold the chart instance

        // --- Event Listeners ---

        // Calculate Button Logic
        calculateBtn.addEventListener('click', () => {
            const years = getVal('analysis-period');
            const results = calculateInternational(years);

            if (results) {
                displayResults(results, years);
            }
        });

        // --- Helper Functions ---

        /**
         * Gets the numerical value from an input field.
         * @param {string} id - The ID of the input element.
         * @returns {number} - The parsed float value, or 0 if empty/invalid.
         */
        function getVal(id) {
            const el = document.getElementById(id);
            if (!el) {
                console.error('Element not found:', id); 
                return 0;
            }
            return parseFloat(el.value) || 0;
        }

        /**
         * Formats a number as currency (using generic style for int'l)
         * @param {number} value - The number to format.
         * @returns {string} - Formatted currency string.
         */
        function formatCurrency(value) {
            // Use Math.round for display consistency but keep the number format cleaner
            return new Intl.NumberFormat('en-US', {
                style: 'decimal',
                maximumFractionDigits: 0,
            }).format(Math.round(value));
        }

        // --- Calculation Logic ---

        /**
         * Runs the simulation for the International Market (simplified cash purchase model).
         * @param {number} years - The analysis period.
         * @returns {object} - An object containing final values and history arrays.
         */
        function calculateInternational(years) {
            // --- Get Global Inputs ---
            const inflation = getVal('inflation') / 100;
            const investmentRate = getVal('int-investment-return') / 100;
            const capGainsTax = getVal('int-cap-gains-tax') / 100;

            // --- Get Purchase Inputs ---
            const homePrice = getVal('int-home-price');
            const initialCostsPct = getVal('int-initial-costs-pct') / 100;
            const initialCostsAbs = getVal('int-initial-costs-abs');
            // Calculate true home cost basis for tax purposes (Price + Initial Costs)
            const initialHomeBasis = homePrice * (1 + initialCostsPct) + initialCostsAbs; 
            
            const fixedTermAbs = getVal('int-fixed-term-abs');
            const fixedTermYears = getVal('int-fixed-term-years');
            const otherYearlyAbs = getVal('int-other-yearly-abs');
            const otherYearlyPct = getVal('int-other-yearly-pct') / 100;
            const appreciation = getVal('int-home-appreciation') / 100;
            const endTermPct = getVal('int-end-term-pct') / 100;
            const endTermAbs = getVal('int-end-term-abs');
            const sellingCostsPct = getVal('int-selling-costs-pct') / 100;

            // --- Get Renter Inputs ---
            let currentRent = getVal('int-yearly-rent');
            const rentIncrease = getVal('int-rent-increase') / 100;
            const rentAdditionalYearlyAbs = getVal('int-rent-additional-yearly-abs');

            // --- Get Deposit/Investment Inputs ---
            const initialDepositBuyer = getVal('int-initial-deposit-buyer');
            const initialDepositRenter = getVal('int-initial-deposit-renter');

            const depositDuringFixedTerm = getVal('int-purchase-yearly-deposit');
            const depositAfterFixedTerm = getVal('int-purchase-yearly-investment-after');
            const buyerDepositIncrease = getVal('int-purchase-yearly-deposit-increase') / 100;
            
            let currentYearlyDepositRenter = getVal('int-rental-yearly-deposit');
            const yearlyDepositIncreaseRenter = getVal('int-rental-yearly-deposit-increase') / 100;

            // --- Initial State (Year 0) ---
            let ownerInvestmentPortfolio = initialDepositBuyer;
            let ownerPortfolioBasis = initialDepositBuyer;
            let renterInvestment = initialDepositRenter;
            let renterPortfolioBasis = initialDepositRenter;

            // --- Simulation Setup (Tracking Variables) ---
            let currentHomeValue = homePrice;
            let currentOtherYearlyAbs = otherYearlyAbs; 
            let currentRentAdditionalYearlyAbs = rentAdditionalYearlyAbs; 
            let currentDepositDuring = depositDuringFixedTerm;
            let currentDepositAfter = depositAfterFixedTerm;

            // --- Simulation ---
            let ownerNetWorthHistory = [];
            let renterNetWorthHistory = [];
            let yearByYearData = []; // To store detailed breakdown

            // --- Year 0 Initial State ---
            const initialOwnerNetWorth = currentHomeValue + ownerInvestmentPortfolio;
            ownerNetWorthHistory.push(initialOwnerNetWorth); 
            renterNetWorthHistory.push(renterInvestment);
            
            yearByYearData.push({
                year: 0,
                type: 'Yearly',
                owner: {
                    costs: { fixed: 0, otherAbsolute: 0, otherPercent: 0, total: 0 },
                    investment: { deposit: 0, totalPortfolio: ownerInvestmentPortfolio },
                    homeValue: currentHomeValue,
                    netWorth: initialOwnerNetWorth
                },
                renter: {
                    costs: { rent: 0, otherAbsolute: 0, total: 0 },
                    investment: { deposit: 0, savings: 0, totalPortfolio: renterInvestment },
                    netWorth: renterInvestment
                }
            });


            for (let year = 1; year <= years; year++) {
                // --- 1. Store Start-of-Year values for EOY calculation ---
                const eoyHomeValue = currentHomeValue * (1 + appreciation);

                // --- 2. Owner Simulation ---
                const yearlyFixed = (year <= fixedTermYears) ? fixedTermAbs : 0;
                const ownerOtherPercentCost = currentHomeValue * otherYearlyPct;
                const yearlyOther = currentOtherYearlyAbs + ownerOtherPercentCost;
                const totalOwnerCosts = yearlyFixed + yearlyOther;
                
                const yearlyOwnerDeposit = (year <= fixedTermYears)
                    ? currentDepositDuring
                    : currentDepositAfter;

                // --- 3. Renter Simulation ---
                const renterCost = currentRent + currentRentAdditionalYearlyAbs;
                const yearlySavings = totalOwnerCosts - renterCost;
                
                // --- 4. Apply Investments & Growth (Pre-Transaction State) ---
                let ownerPortfolioBeforeGrowth = ownerInvestmentPortfolio + yearlyOwnerDeposit;
                let eoyOwnerPortfolio = ownerPortfolioBeforeGrowth * (1 + investmentRate);
                
                let renterPortfolioBeforeGrowth = renterInvestment + currentYearlyDepositRenter + yearlySavings;
                let eoyRenterPortfolio = renterPortfolioBeforeGrowth * (1 + investmentRate);

                let eoyOwnerNetWorth = eoyHomeValue + eoyOwnerPortfolio;
                const eoyRenterNetWorth = eoyRenterPortfolio;

                
                // --- 5. Apply Fixed-Term Expiration Expenses (If applicable) ---
                let endTermTransactionCost = 0;
                let ownerNetWorthBeforeEndTerm = eoyOwnerNetWorth;

                if (year === fixedTermYears && fixedTermYears > 0) {
                    endTermTransactionCost = (eoyHomeValue * endTermPct) + endTermAbs;
                    
                    // Deduct from portfolio and net worth
                    eoyOwnerPortfolio -= endTermTransactionCost;
                    eoyOwnerNetWorth -= endTermTransactionCost;
                    
                    // Note: Basis is not changed as this is payment from the portfolio's growth/principal.
                }

                
                // --- 6. Store History & Data for Table ---
                // Store Net Worth history for Chart AFTER end-term expense deduction (if applicable)
                ownerNetWorthHistory.push(eoyOwnerNetWorth); 
                renterNetWorthHistory.push(eoyRenterNetWorth);

                yearByYearData.push({
                    year: year,
                    type: 'Yearly',
                    owner: {
                        costs: { 
                            fixed: yearlyFixed, 
                            otherAbsolute: currentOtherYearlyAbs, 
                            otherPercent: ownerOtherPercentCost, 
                            total: totalOwnerCosts 
                        },
                        investment: { 
                            deposit: yearlyOwnerDeposit, 
                            totalPortfolio: eoyOwnerPortfolio // Store EOY value
                        },
                        homeValue: eoyHomeValue, // Store EOY value
                        netWorth: eoyOwnerNetWorth
                    },
                    renter: {
                        costs: { 
                            rent: currentRent, 
                            otherAbsolute: currentRentAdditionalYearlyAbs, 
                            total: renterCost 
                        },
                        investment: { 
                            deposit: currentYearlyDepositRenter, 
                            savings: yearlySavings, 
                            totalPortfolio: eoyRenterPortfolio // Store EOY value
                        },
                        netWorth: eoyRenterNetWorth
                    }
                });

                // If Fixed Term expired, insert a transaction row
                if (year === fixedTermYears && fixedTermYears > 0 && endTermTransactionCost > 0) {
                    yearByYearData.push({
                        year: year,
                        type: 'EndTermExpense',
                        owner: {
                            endTermCost: endTermTransactionCost,
                            netWorthAfter: eoyOwnerNetWorth,
                            netWorthBefore: ownerNetWorthBeforeEndTerm, // Pass pre-deduction value
                            homeValueAtTermEnd: eoyHomeValue // Pass Home Value for breakdown
                        },
                        renter: {
                            netWorthAfter: eoyRenterNetWorth
                        }
                    });
                }

                // --- 7. Update tracking variables for NEXT year ---
                currentHomeValue = eoyHomeValue; // Update for next loop
                ownerInvestmentPortfolio = eoyOwnerPortfolio; // Update for next loop (includes end-term deduction)
                renterInvestment = eoyRenterPortfolio; // Update for next loop 

                // Update basis
                ownerPortfolioBasis += yearlyOwnerDeposit;
                renterPortfolioBasis += currentYearlyDepositRenter;
                if (yearlySavings > 0) {
                    renterPortfolioBasis += yearlySavings;
                }

                // Inflate costs/deposits for next loop
                currentOtherYearlyAbs *= (1 + inflation);
                currentDepositDuring *= (1 + buyerDepositIncrease);
                currentDepositAfter *= (1 + buyerDepositIncrease);
                currentRent *= (1 + rentIncrease);
                currentRentAdditionalYearlyAbs *= (1 + inflation);
                currentYearlyDepositRenter *= (1 + yearlyDepositIncreaseRenter);
            }

            // --- Final Calculations (Post-Simulation Transaction) ---
            
            // State at the end of the analysis period (after all yearly growth/expenses)
            const finalOwnerHomeValue = currentHomeValue;
            const finalOwnerPortfolio = ownerInvestmentPortfolio;
            const finalRenterPortfolio = renterInvestment;

            // 1. Owner Home Sale Transaction
            const sellingCost = finalOwnerHomeValue * sellingCostsPct;
            let homeProceeds = finalOwnerHomeValue - sellingCost;
            
            // Home Capital Gains Tax: REMOVED as per user request. Only selling costs apply.
            let homeTax = 0;
            // Original logic for reference (now removed):
            /*
            const homeGains = homeProceeds - initialHomeBasis; 
            if (homeGains > 0) {
                homeTax = homeGains * capGainsTax;
                homeProceeds -= homeTax; // Deducting tax
            }
            */
            

            // 2. Owner Portfolio Liquidation Tax
            const ownerPortfolioGains = finalOwnerPortfolio - ownerPortfolioBasis;
            let ownerPortfolioTax = 0;
            if (ownerPortfolioGains > 0) {
                ownerPortfolioTax = ownerPortfolioGains * capGainsTax;
            }
            
            // 3. Renter Portfolio Liquidation Tax
            const renterGains = finalRenterPortfolio - renterPortfolioBasis;
            let renterTax = 0;
            if (renterGains > 0) {
                renterTax = renterGains * capGainsTax;
            }
            
            // Calculate final net worths
            // Home proceeds are now tax-free (only selling costs deducted)
            const finalOwnerNetWorth = homeProceeds + (finalOwnerPortfolio - ownerPortfolioTax); 
            const finalRenterNetWorth = finalRenterPortfolio - renterTax;

            // Add transaction row for Final Sale/Liquidation
            yearByYearData.push({
                year: years,
                type: 'FinalSale',
                owner: {
                    salePrice: finalOwnerHomeValue,
                    sellingCost: sellingCost,
                    homeTax: homeTax, // This will be 0
                    ownerPortfolio: finalOwnerPortfolio,
                    ownerPortfolioTax: ownerPortfolioTax,
                    finalNetWorth: finalOwnerNetWorth
                },
                renter: {
                    portfolio: finalRenterPortfolio,
                    renterTax: renterTax,
                    finalNetWorth: finalRenterNetWorth
                }
            });

            // Update Net Worth History for final point to reflect sale/tax
            ownerNetWorthHistory[years] = finalOwnerNetWorth;
            renterNetWorthHistory[years] = finalRenterNetWorth;
            
            return {
                owner: finalOwnerNetWorth,
                renter: finalRenterNetWorth,
                ownerHistory: ownerNetWorthHistory,
                renterHistory: renterNetWorthHistory,
                yearByYearData: yearByYearData
            };
        }
        
        // --- Display Functions ---

        /**
         * Renders the results and the chart.
         * @param {object} results - The results object from the calculation.
         * @param {number} years - The analysis period.
         */
        function displayResults(results, years) {
            resultsYears.textContent = years;
            
            const { owner, renter, ownerHistory, renterHistory, yearByYearData } = results;

            ownerNetWorthEl.textContent = formatCurrency(owner);
            renterNetWorthEl.textContent = formatCurrency(renter);
            
            const benefit = Math.abs(owner - renter);
            if (owner > renter) {
                winnerEl.textContent = "Owning";
                netBenefitEl.textContent = formatCurrency(benefit);
                netBenefitEl.classList.add('text-cyan-400');
                netBenefitEl.classList.remove('text-lime-400', 'text-white');
            } else {
                winnerEl.textContent = "Renting";
                netBenefitEl.textContent = formatCurrency(benefit);
                netBenefitEl.classList.add('text-lime-400');
                netBenefitEl.classList.remove('text-cyan-400', 'text-white');
            }

            renderChart(ownerHistory, renterHistory, years);
            renderTable(yearByYearData); // Call the table render function
            resultsSection.classList.remove('hidden');
        }

        /**
         * Renders the year-by-year data table, including transaction rows.
         * @param {Array} data - The yearByYearData array from calculations.
         */
        function renderTable(data) {
            const container = document.getElementById('results-table-container');
            if (!container) return;
            
            const sellingCostsPctForTable = getVal('int-selling-costs-pct'); 
            const endTermPctForTable = getVal('int-end-term-pct');
            const endTermAbsForTable = getVal('int-end-term-abs');

            let tableHTML = `
                <table class="min-w-full divide-y divide-gray-700">
                    <thead class="bg-gray-800 sticky top-0 z-10">
                        <tr>
                            <th scope="col" class="py-3.5 px-3 text-left text-xs font-semibold text-gray-400 uppercase tracking-wider">Year</th>
                            
                            <th scope="col" class="py-3.5 px-3 text-left text-xs font-semibold text-cyan-400 uppercase tracking-wider">Owner Fixed Exp.</th>
                            <th scope="col" class="py-3.5 px-3 text-left text-xs font-semibold text-cyan-400 uppercase tracking-wider">Owner Other Exp.</th>
                            <th scope="col" class="py-3.5 px-3 text-left text-xs font-semibold text-cyan-400 uppercase tracking-wider">Owner Total Exp.</th>
                            <th scope="col" class="py-3.5 px-3 text-left text-xs font-semibold text-cyan-400 uppercase tracking-wider">Owner Deposit</th>
                            <th scope="col" class="py-3.5 px-3 text-left text-xs font-semibold text-cyan-400 uppercase tracking-wider">Owner Portfolio</th>
                            <th scope="col" class="py-3.5 px-3 text-left text-xs font-semibold text-cyan-400 uppercase tracking-wider">Home Value</th>
                            <th scope="col" class="py-3.5 px-3 text-left text-xs font-semibold text-cyan-400 uppercase tracking-wider">Owner Net Worth</th>
                            
                            <th scope="col" class="py-3.5 px-3 text-left text-xs font-semibold text-lime-400 uppercase tracking-wider">Renter Rent</th>
                            <th scope="col" class="py-3.5 px-3 text-left text-xs font-semibold text-lime-400 uppercase tracking-wider">Renter Other Exp.</th>
                            <th scope="col" class="py-3.5 px-3 text-left text-xs font-semibold text-lime-400 uppercase tracking-wider">Renter Total Exp.</th>
                            <th scope="col" class="py-3.5 px-3 text-left text-xs font-semibold text-lime-400 uppercase tracking-wider">Renter Deposit</th>
                            <th scope="col" class="py-3.5 px-3 text-left text-xs font-semibold text-lime-400 uppercase tracking-wider">Renter Savings</th>
                            <th scope="col" class="py-3.5 px-3 text-left text-xs font-semibold text-lime-400 uppercase tracking-wider">Renter Portfolio</th>
                            <th scope="col" class="py-3.5 px-3 text-left text-xs font-semibold text-lime-400 uppercase tracking-wider">Renter Net Worth</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-700 bg-gray-900">
            `;

            // Loop through data and build table rows
            data.forEach(yearData => {
                const year = yearData.year;
                
                if (yearData.type === 'EndTermExpense') {
                    const o = yearData.owner;
                    const homeValueAtTermEnd = o.homeValueAtTermEnd; // Retrieve Home Value for calculation breakdown
                    
                    // Calculation breakdown:
                    // Note: endTermPctForTable is a percentage (e.g., 5.0). Must divide by 100 for calculation.
                    const pctExpenseAmount = homeValueAtTermEnd * (endTermPctForTable / 100);
                    const absExpenseAmount = endTermAbsForTable; // Absolute value is already a number
                    
                    // End-of-Term Expense Row - Detailed Transaction Summary
                    tableHTML += `
                        <tr class="bg-gray-700 border-t-2 border-yellow-500 border-b-2 border-yellow-500">
                            <td colspan="15" class="py-4 px-3 text-sm text-center">
                                <span class="font-bold text-xl text-yellow-300 block mb-4">YEAR ${year} END OF FIXED TERM EXPENSE TRANSACTION</span>
                                
                                <div class="grid grid-cols-4 gap-4 items-center bg-gray-800 p-4 rounded-lg">
                                    <div class="text-right text-gray-400 font-bold text-lg">Owner Net Worth BEFORE Deduction:</div>
                                    <div class="text-left text-white font-bold text-lg">${formatCurrency(o.netWorthBefore)}</div>
                                    <div></div>
                                    <div></div>
                                    
                                    <div class="text-right text-yellow-300 font-medium border-t border-gray-600 pt-3">Expense Component 1 (% of Price):</div>
                                    <div class="text-left text-white border-t border-gray-600 pt-3">${endTermPctForTable.toFixed(1)}% of Home Value (${formatCurrency(homeValueAtTermEnd)})</div>
                                    <div class="text-right text-red-400 border-t border-gray-600 pt-3">Deducted Amount:</div>
                                    <div class="text-left text-red-400 font-medium border-t border-gray-600 pt-3">-${formatCurrency(pctExpenseAmount)}</div>
                                    
                                    <div class="text-right text-yellow-300 font-medium">Expense Component 2 (Absolute):</div>
                                    <div class="text-left text-white">${formatCurrency(absExpenseAmount)} (Input Value)</div>
                                    <div class="text-right text-red-400">Deducted Amount:</div>
                                    <div class="text-left text-red-400 font-medium">-${formatCurrency(absExpenseAmount)}</div>

                                    <div class="col-span-4 border-t border-gray-600 my-2"></div>

                                    <div class="text-right text-yellow-300 font-bold text-xl">TOTAL DEDUCTION:</div>
                                    <div></div>
                                    <div class="text-right text-red-400 font-bold text-2xl"></div>
                                    <div class="text-left text-red-400 font-bold text-2xl">-${formatCurrency(o.endTermCost)}</div>

                                    <div class="col-span-4 border-t border-gray-600 my-2"></div>

                                    <div class="text-right text-cyan-400 font-bold text-xl">Owner Net Worth AFTER Deduction:</div>
                                    <div class="text-left text-cyan-400 font-bold text-xl">${formatCurrency(o.netWorthAfter)}</div>
                                    <div></div>
                                    <div></div>
                                </div>
                            </td>
                        </tr>
                    `;
                } else if (yearData.type === 'FinalSale') {
                    const o = yearData.owner;
                    const r = yearData.renter;
                    
                    // Final Sale/Liquidation Transaction Row - Home Sale/Costs
                    tableHTML += `
                        <tr class="bg-gray-700 border-t-2 border-green-500">
                            <td class="whitespace-nowrap py-4 px-3 text-sm font-bold text-green-300">Year ${year}</td>
                            <td colspan="6" class="py-4 px-3 text-sm font-semibold text-green-300 text-right">
                                HOME SALE: Proceeds Before Costs
                            </td>
                            <td class="whitespace-nowrap py-4 px-3 text-sm font-bold text-white">${formatCurrency(o.salePrice)}</td>
                            <td colspan="7" class="py-4 px-3 text-sm font-semibold text-gray-400"></td>
                        </tr>
                        <tr class="bg-gray-700">
                            <td class="whitespace-nowrap py-4 px-3 text-sm font-bold text-green-300"></td>
                            <td colspan="6" class="py-4 px-3 text-sm font-semibold text-green-300 text-right">
                                HOME SALE: Selling Costs (${sellingCostsPctForTable.toFixed(1)}% of Price)
                            </td>
                            <td class="whitespace-nowrap py-4 px-3 text-sm font-bold text-red-500">-${formatCurrency(o.sellingCost)}</td>
                            <td colspan="7" class="py-4 px-3 text-sm font-semibold text-gray-400"></td>
                        </tr>
                        <tr class="bg-gray-700">
                            <td class="whitespace-nowrap py-4 px-3 text-sm font-bold text-green-300"></td>
                            <td colspan="6" class="py-4 px-3 text-sm font-semibold text-green-300 text-right">
                                HOME SALE: Capital Gains Tax (Now Excluded)
                            </td>
                            <td class="whitespace-nowrap py-4 px-3 text-sm font-bold text-red-500">-${formatCurrency(o.homeTax)}</td>
                            <td colspan="7" class="py-4 px-3 text-sm font-semibold text-gray-400"></td>
                        </tr>
                        <tr class="bg-gray-700 border-b-2 border-green-500">
                            <td class="whitespace-nowrap py-4 px-3 text-sm font-bold text-green-300"></td>
                            <td colspan="3" class="py-4 px-3 text-sm font-semibold text-green-300 text-right">
                                PORTFOLIO: Tax on Investment Gains
                            </td>
                            <td class="whitespace-nowrap py-4 px-3 text-sm font-bold text-red-500">-${formatCurrency(o.ownerPortfolioTax)}</td>
                            <td colspan="2" class="py-4 px-3 text-sm font-semibold text-green-300 text-right">
                                FINAL OWNER NET WORTH
                            </td>
                            <td class="whitespace-nowrap py-4 px-3 text-sm font-bold text-cyan-400">${formatCurrency(o.finalNetWorth)}</td>
                            
                            <td colspan="5" class="py-4 px-3 text-sm font-semibold text-green-300 text-right">
                                PORTFOLIO: Tax on Investment Gains
                            </td>
                            <td class="whitespace-nowrap py-4 px-3 text-sm font-bold text-red-500">-${formatCurrency(r.renterTax)}</td>
                            <td class="whitespace-nowrap py-4 px-3 text-sm font-semibold text-lime-400 text-right">
                                FINAL RENTER NET WORTH
                            </td>
                            <td class="whitespace-nowrap py-4 px-3 text-sm font-bold text-lime-400">${formatCurrency(r.finalNetWorth)}</td>
                        </tr>
                    `;
                } else if (yearData.type === 'Yearly') {
                    // Standard Yearly Row
                    const o = yearData.owner;
                    const r = yearData.renter;
                    const ownerOtherTotal = o.costs.otherAbsolute + o.costs.otherPercent;
                    const renterOtherTotal = r.costs.otherAbsolute;

                    tableHTML += `
                        <tr>
                            <td class="whitespace-nowrap py-4 px-3 text-sm font-medium text-white">${year}</td>
                            
                            <td class="whitespace-nowrap py-4 px-3 text-sm text-gray-300">${formatCurrency(o.costs.fixed)}</td>
                            <td class="whitespace-nowrap py-4 px-3 text-sm text-gray-300">${formatCurrency(ownerOtherTotal)}</td>
                            <td class="whitespace-nowrap py-4 px-3 text-sm text-gray-300 font-medium">${formatCurrency(o.costs.total)}</td>
                            <td class="whitespace-nowrap py-4 px-3 text-sm text-gray-300">${formatCurrency(o.investment.deposit)}</td>
                            <td class="whitespace-nowrap py-4 px-3 text-sm text-gray-300 font-bold">${formatCurrency(o.investment.totalPortfolio)}</td>
                            <td class="whitespace-nowrap py-4 px-3 text-sm text-gray-300">${formatCurrency(o.homeValue)}</td>
                            <td class="whitespace-nowrap py-4 px-3 text-sm text-cyan-400 font-bold">${formatCurrency(o.netWorth)}</td>
                            
                            <td class="whitespace-nowrap py-4 px-3 text-sm text-gray-300">${formatCurrency(r.costs.rent)}</td>
                            <td class="whitespace-nowrap py-4 px-3 text-sm text-gray-300">${formatCurrency(renterOtherTotal)}</td>
                            <td class="whitespace-nowrap py-4 px-3 text-sm text-gray-300 font-medium">${formatCurrency(r.costs.total)}</td>
                            <td class="whitespace-nowrap py-4 px-3 text-sm text-gray-300">${formatCurrency(r.investment.deposit)}</td>
                            <td class="whitespace-nowrap py-4 px-3 text-sm text-gray-300">${formatCurrency(r.investment.savings)}</td>
                            <td class="whitespace-nowrap py-4 px-3 text-sm text-gray-300 font-bold">${formatCurrency(r.investment.totalPortfolio)}</td>
                            <td class="whitespace-nowrap py-4 px-3 text-sm text-lime-400 font-bold">${formatCurrency(r.netWorth)}</td>
                        </tr>
                    `;
                }
            });

            tableHTML += `
                    </tbody>
                </table>
            `;

            container.innerHTML = tableHTML;
        }


        /**
         * Renders the line chart using Chart.js.
         */
        function renderChart(ownerHistory, renterHistory, years) {
            const ctx = chartCanvas.getContext('2d');
            const labels = Array.from({ length: years + 1 }, (_, i) => `Year ${i}`);

            if (myChart) {
                myChart.destroy(); // Destroy previous chart instance
            }

            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Owner Net Worth',
                            data: ownerHistory,
                            borderColor: 'rgb(34, 211, 238)', // cyan-400
                            backgroundColor: 'rgba(34, 211, 238, 0.1)',
                            fill: true,
                            tension: 0.1
                        },
                        {
                            label: 'Renter Net Worth',
                            data: renterHistory,
                            borderColor: 'rgb(163, 230, 53)', // lime-400
                            backgroundColor: 'rgba(163, 230, 53, 0.1)',
                            fill: true,
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                color: '#d1d5db', // gray-300
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)' // White with alpha
                            }
                        },
                        x: {
                            ticks: {
                                color: '#d1d5db', // gray-300
                            },
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#d1d5db' // gray-300
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += formatCurrency(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
            
            // Set explicit height for the canvas container
            chartCanvas.parentElement.style.height = '400px';
        }

    </script>
</body>
</html>
