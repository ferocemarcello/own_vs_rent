<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buy vs. Rent Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Ensure inputs are visible in dark mode */
        input[type="number"] {
            @apply text-white;
        }
    </style>
    <script>
        // Set up Tailwind dark mode
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        }
    </script>
</head>
<body class="bg-gray-900 text-gray-200 font-sans antialiased p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <h1 class="text-3xl font-bold text-center text-white mb-8">Buy vs. Rent Calculator</h1>

        <div class="bg-gray-800 p-6 rounded-xl shadow-lg mb-8 max-w-2xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <label for="analysis-period" class="block text-lg font-semibold text-white">Analysis Period (Years)</label>
                <input type="number" id="analysis-period" value="30" class="w-full mt-2 bg-gray-700 border border-gray-600 rounded-md p-3 focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div>
                <label for="inflation" class="block text-lg font-semibold text-white">Yearly Inflation (%)</label>
                <input type="number" id="inflation" value="3.0" class="w-full mt-2 bg-gray-700 border border-gray-600 rounded-md p-3 focus:ring-blue-500 focus:border-blue-500">
            </div>
        </div>

        <div class="max-w-4xl mx-auto mb-8">
            <div class="bg-gray-800 rounded-xl shadow-lg">
                <button id="toggle-help-btn" class="w-full flex justify-between items-center p-6 text-left text-xl font-semibold text-white focus:outline-none transition-colors duration-200 hover:bg-gray-700 rounded-t-xl">
                    <span>How This Works (Click to Expand)</span>
                    <svg id="help-chevron" class="w-6 h-6 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </button>
                
                <div id="help-content" class="hidden p-6 border-t border-gray-700">
                    <div class="text-gray-300 space-y-6">
                        <div>
                            <h3 class="text-xl font-semibold text-white mb-2">The Core Logic</h3>
                            <p>This calculator simulates the financial outcome of buying a home versus renting over a set period. It compares the final net worth of an <strong>Owner</strong> against a <strong>Renter</strong> by tracking two main assets for each:</p>
                            <ol class="list-decimal list-inside pl-4 mt-2 space-y-1">
                                <li><strong>Property Equity (Owner only):</strong> The value of the home, which appreciates (or depreciates) over time.</li>
                                <li><strong>Investment Portfolio:</strong> A separate investment account (like stocks or bonds) that both the Owner and Renter contribute to and which grows at a specified yearly rate.</li>
                            </ol>
                        </div>
                
                        <div>
                            <h3 class="text-xl font-semibold text-white mb-2">Final Calculation (End of Period)</h3>
                            <p>At the end of the "Analysis Period," the calculator simulates a final liquidation to compare net worth:</p>
                            <ol class="list-decimal list-inside pl-4 mt-2 space-y-1">
                                <li>The <strong>Owner</strong> "sells" the house. The <strong>Selling Costs</strong> are tracked as an expense but <strong>NOT deducted</strong> from the final Net Worth.</li>
                                <li>Both the <strong>Owner</strong> and <strong>Renter</strong> "liquidate" their investment portfolios.</li>
                                <li>The <strong>Capital Gains Tax</strong> is calculated only on the "growth" (gains) of their portfolios.</li>
                                <li><strong>Final Net Worth = (Full Home Value) + (Net Portfolio Value)</strong></li>
                            </ol>
                        </div>
                        <div class="p-4 bg-blue-900/30 border-l-4 border-blue-500 rounded-r-lg">
                            <h3 class="text-xl font-semibold text-white mb-2">Logic: One-Time Expenses</h3>
                            <p class="mb-2">
                                One-time expenses for the ownerâ€”specifically <strong>Initial Buying Costs</strong>, <strong>End of Term (Refinancing) Costs</strong>, and <strong>Final Selling Costs</strong>â€”are <strong>NOT</strong> deducted from the Owner's Net Worth or Investment Portfolio in this simulation.
                            </p>
                            <p class="mt-2">
                                It is supposed that when there are no recurring expenses, but only one-time (initial, end of term, sale) costs, those are just handled by the owner with a temporarily less costly lifestyle.
                            </p>
                            <p class="mt-2">
                                These costs are still tracked in the "Total Expenses" graph and the new "Cost Summary" panel to show the true cost of ownership, but they do not negatively impact the final asset value.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div>
            <div id="international-version">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    
                    <div class="bg-gray-800 p-6 rounded-xl shadow-lg space-y-4">
                        <h2 class="text-2xl font-semibold text-white border-b border-gray-700 pb-3">Purchase Inputs</h2>
                        
                        <div>
                            <label for="int-home-price" class="block text-sm font-medium text-gray-300">Home Initial Price</label>
                            <input type="number" id="int-home-price" value="300000" class="mt-1 w-full bg-gray-700 border-gray-600 rounded-md p-2">
                        </div>

                        <div>
                            <label for="int-initial-costs-pct" class="block text-sm font-medium text-gray-300">Initial Costs (% of Home Price)</label>
                            <input type="number" id="int-initial-costs-pct" value="2.5" class="mt-1 w-full bg-gray-700 border-gray-600 rounded-md p-2">
                        </div>
                        
                        <div>
                            <label for="int-initial-costs-abs" class="block text-sm font-medium text-gray-300">Initial Costs (Absolute)</label>

                            <input type="number" id="int-initial-costs-abs" value="2000" class="mt-1 w-full bg-gray-700 border-gray-600 rounded-md p-2">
                        </div>

                        <div>
                            <label for="int-fixed-term-abs" class="block text-sm font-medium text-gray-300">Yearly Expenses with Fixed Term (Absolute)(e.g. mortgage)</label>
                            <input type="number" id="int-fixed-term-abs" value="15000" class="mt-1 w-full bg-gray-700 border-gray-600 rounded-md p-2">
                        </div>

                        <div>
                            <label for="int-fixed-term-years" class="block text-sm font-medium text-gray-300">Years for Fixed Term Expenses(e.g. mortgage duration)</label>
                            <input type="number" id="int-fixed-term-years" value="20" class="mt-1 w-full bg-gray-700 border-gray-600 rounded-md p-2">
                        </div>
                        
                        <div>
                            <label for="int-purchase-yearly-investment" class="block text-sm font-medium text-gray-300">Yearly Investment during fixed term</label>
                            <input type="number" id="int-purchase-yearly-investment" value="10000" class="mt-1 w-full bg-gray-700 border-gray-600 rounded-md p-2">
                        </div>

                        <div>
                            <label for="int-purchase-yearly-investment-increase" class="block text-sm font-medium text-gray-300">Yearly Investment Increase (%/year)</label>
                            <input type="number" id="int-purchase-yearly-investment-increase" value="2" class="mt-1 w-full bg-gray-700 border-gray-600 rounded-md p-2">
                        </div>

                        <div>
                            <label for="int-additional-yearly-expenses-buyer" class="block text-sm font-medium text-gray-300">Additional Yearly Expenses (Absolute)</label>
                            <input type="number" id="int-additional-yearly-expenses-buyer" value="5000" class="mt-1 w-full bg-gray-700 border-gray-600 rounded-md p-2">
                        </div>

                        <div>
                            <label for="int-additional-yearly-pct-purchase" class="block text-sm font-medium text-gray-300">Additional Yearly Expenses (% of Home Value)</label>
                            <input type="number" id="int-additional-yearly-pct-purchase" value="1" class="mt-1 w-full bg-gray-700 border-gray-600 rounded-md p-2">
                        </div>

                        <div>
                            <label for="int-home-appreciation" class="block text-sm font-medium text-gray-300">Home Yearly Appreciation (%)</label>
                            <input type="number" id="int-home-appreciation" value="4.0" class="mt-1 w-full bg-gray-700 border-gray-600 rounded-md p-2">
                        </div>
                        
                        <div>
                            <label for="int-end-term-pct" class="block text-sm font-medium text-gray-300">Expenses at End of Term (% of Price)</label>
                            <input type="number" id="int-end-term-pct" value="2" class="mt-1 w-full bg-gray-700 border-gray-600 rounded-md p-2">
                        </div>

                        <div>
                            <label for="int-end-term-expenses-abs" class="block text-sm font-medium text-gray-300">Expenses at End of Term (Absolute)</label>
                            <input type="number" id="int-end-term-expenses-abs" value="2000" class="mt-1 w-full bg-gray-700 border-gray-600 rounded-md p-2">
                        </div>
                        
                        <div>
                            <label for="int-selling-costs-pct" class="block text-sm font-medium text-gray-300">Selling Costs (% of Final Price)</label>
                            <input type="number" id="int-selling-costs-pct" value="2.0" class="mt-1 w-full bg-gray-700 border-gray-600 rounded-md p-2">
                        </div>
                        
                        <div>
                            <label for="int-purchase-yearly-investment-after" class="block text-sm font-medium text-gray-300">Yearly Investment after fixed term</label>
                            <input type="number" id="int-purchase-yearly-investment-after" value="30000" class="mt-1 w-full bg-gray-700 border-gray-600 rounded-md p-2">
                        </div>
                    </div>

                    <div class="bg-gray-800 p-6 rounded-xl shadow-lg space-y-4">
                        <h2 class="text-2xl font-semibold text-white border-b border-gray-700 pb-3">Rental Inputs</h2>
                        
                        <div>
                            <label for="int-yearly-rent" class="block text-sm font-medium text-gray-300">Yearly Rent (Absolute)</label>
                            <input type="number" id="int-yearly-rent" value="10000" class="mt-1 w-full bg-gray-700 border-gray-600 rounded-md p-2">
                        </div>

                        <div>
                            <label for="int-rent-increase" class="block text-sm font-medium text-gray-300">Rent Increase (%/year)</label>
                            <input type="number" id="int-rent-increase" value="3.0" class="mt-1 w-full bg-gray-700 border-gray-600 rounded-md p-2">
                        </div>

                        <div>
                            <label for="int-rent-additional-yearly-expenses-abs" class="block text-sm font-medium text-gray-300">Additional Yearly Expenses (Absolute)</label>
                            <input type="number" id="int-rent-additional-yearly-expenses-abs" value="1500" class="mt-1 w-full bg-gray-700 border-gray-600 rounded-md p-2">
                        </div>

                        <div>
                            <label for="int-rental-yearly-investment" class="block text-sm font-medium text-gray-300">Yearly Investment</label>
                            <input type="number" id="int-rental-yearly-investment" value="20000" class="mt-1 w-full bg-gray-700 border-gray-600 rounded-md p-2">
                        </div>

                        <div>
                            <label for="int-rental-yearly-investment-increase" class="block text-sm font-medium text-gray-300">Yearly Investment Increase (%/year)</label>
                            <input type="number" id="int-rental-yearly-investment-increase" value="2" class="mt-1 w-full bg-gray-700 border-gray-600 rounded-md p-2">
                        </div>
                    </div>

                    <div class="bg-gray-800 p-6 rounded-xl shadow-lg space-y-4">
                        <h2 class="text-2xl font-semibold text-white border-b border-gray-700 pb-3">Investment Inputs</h2>

                        <div>
                            <label for="int-initial-portfolio-value-buyer" class="block text-sm font-medium text-gray-300">Initial Portfolio Value (for Buyer)</label>
                            <input type="number" id="int-initial-portfolio-value-buyer" value="0" class="mt-1 w-full bg-gray-700 border-gray-600 rounded-md p-2">
                        </div>

                        <div>
                            <label for="int-initial-portfolio-value-renter" class="block text-sm font-medium text-gray-300">Initial Portfolio Value (for Renter)</label>
                            <input type="number" id="int-initial-portfolio-value-renter" value="50000" class="mt-1 w-full bg-gray-700 border-gray-600 rounded-md p-2">
                        </div>
                        
                        <div>
                            <label for="int-investment-return" class="block text-sm font-medium text-gray-300">Investment Return (%/year)</label>
                            <input type="number" id="int-investment-return" value="10" class="mt-1 w-full bg-gray-700 border-gray-600 rounded-md p-2">
                        </div>

                        <div>
                            <label for="int-cap-gains-tax" class="block text-sm font-medium text-gray-300">Capital Gains Tax (%)</label>
                            <input type="number" id="int-cap-gains-tax" value="25.0" class="mt-1 w-full bg-gray-700 border-gray-600 rounded-md p-2">
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <div class="text-center mt-8">
            <button id="calculate-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg text-lg transition duration-300 shadow-lg">
                Calculate
            </button>
        </div>

        </div>

    <div id="results-section" class="mt-10 bg-gray-800 p-6 rounded-xl shadow-lg hidden">
        <h2 class="text-2xl font-semibold text-white mb-6 text-center">Results after <span id="results-years">10</span> Years</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center mb-8">
            <div>
                <div class="text-sm text-gray-400">Owner's Net Worth</div>
                <div id="owner-net-worth" class="text-3xl font-bold text-cyan-400"></div>
            </div>
            <div>
                <div class="text-sm text-gray-400">Renter's Net Worth</div>
                <div id="renter-net-worth" class="text-3xl font-bold text-lime-400"></div>
            </div>
            <div>
                <div class="text-sm text-gray-400">Net Benefit of <span id="winner"></span></div>
                <div id="net-benefit" class="text-3xl font-bold text-white"></div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-10">
            <div>
                <h3 class="text-lg font-semibold text-white text-center mb-2">Net Worth Growth</h3>
                <div class="h-80">
                    <canvas id="comparison-chart"></canvas>
                </div>
                <p id="chart-annotation-text" class="text-center text-lime-400 font-semibold mt-2 mb-2 hidden text-sm"></p>
            </div>
            <div>
                <h3 class="text-lg font-semibold text-white text-center mb-2">Total Cumulative Expenses (Sunk Costs)</h3>
                <div class="h-80">
                    <canvas id="expenses-chart"></canvas>
                </div>
                <p class="text-center text-gray-400 text-xs mt-2">Includes Initial Costs, Recurring Expenses, End-Term Costs & Selling Costs</p>
            </div>
        </div>
        

        <div class="mt-10 overflow-x-auto">
            <h3 class="text-xl font-semibold text-white mb-4 text-center">Year-by-Year Breakdown</h3>
            <div id="results-table-container">
                <!-- Table inserted here -->
            </div>
        </div>

        <!-- New Cost Summary Panel -->
        <div id="cost-summary-container" class="mt-10">
            <!-- Cost Summary inserted here -->
        </div>

    </div>

    <script>
        // --- DOM Element References ---
        const calculateBtn = document.getElementById('calculate-btn');
        const resultsSection = document.getElementById('results-section');
        const chartCanvas = document.getElementById('comparison-chart');
        const expensesChartCanvas = document.getElementById('expenses-chart');
        
        const resultsYears = document.getElementById('results-years');
        const ownerNetWorthEl = document.getElementById('owner-net-worth');
        const renterNetWorthEl = document.getElementById('renter-net-worth');
        const winnerEl = document.getElementById('winner');
        const netBenefitEl = document.getElementById('net-benefit');

        // --- Help Panel References ---
        const toggleHelpBtn = document.getElementById('toggle-help-btn');
        const helpContent = document.getElementById('help-content');
        const helpChevron = document.getElementById('help-chevron');
        // --- END: Help Panel References ---

        let myChart; // To hold the net worth chart instance
        let myExpensesChart; // To hold the expenses chart instance

        // --- Event Listeners ---

        // --- Help Panel Listener ---
        toggleHelpBtn.addEventListener('click', () => {
            helpContent.classList.toggle('hidden');
            helpChevron.classList.toggle('rotate-180'); // Rotates the chevron icon
        });
        // --- END: Help Panel Listener ---

        // Calculate Button Logic
        calculateBtn.addEventListener('click', () => {
            const years = getVal('analysis-period');
            const results = calculateInternational(years);

            if (results) {
                displayResults(results, years);
            }
        });

        // --- Helper Functions ---

        /**
         * Gets the numerical value from an input field.
         * @param {string} id - The ID of the input element.
         * @returns {number} - The parsed float value, or 0 if empty/invalid.
         */
        function getVal(id) {
            const el = document.getElementById(id);
            if (!el) {
                console.error('Element not found:', id); 
                return 0;
            }
            return parseFloat(el.value) || 0;
        }

        /**
         * Formats a number as currency (using generic style for int'l)
         * @param {number} value - The number to format.
         * @returns {string} - Formatted currency string.
         */
        function formatCurrency(value) {
            // Use Math.round for display consistency but keep the number format cleaner
            return new Intl.NumberFormat('en-US', {
                style: 'decimal',
                maximumFractionDigits: 0,
            }).format(Math.round(value));
        }

        // --- Calculation Logic ---

        /**
         * Runs the simulation for the International Market (simplified cash purchase model).
         * @param {number} years - The analysis period.
         * @returns {object} - An object containing final values and history arrays.
         */
        function calculateInternational(years) {
            // --- Get Global Inputs ---
            const inflation = getVal('inflation') / 100;
            const investmentRate = getVal('int-investment-return') / 100;
            const capGainsTax = getVal('int-cap-gains-tax') / 100;

            // --- Get Purchase Inputs ---
            const homePrice = getVal('int-home-price');
            const initialCostsPct = getVal('int-initial-costs-pct') / 100;
            const initialCostsAbs = getVal('int-initial-costs-abs');
            // Initial Expenses (Sunk Cost)
            const initialBuyingExpenses = (homePrice * initialCostsPct) + initialCostsAbs; 
            
            const fixedTermAbs = getVal('int-fixed-term-abs');
            const fixedTermYears = getVal('int-fixed-term-years');
            const additionalYearlyExpensesBuyerAbs = getVal('int-additional-yearly-expenses-buyer');
            const additionalYearlyPctPurchase = getVal('int-additional-yearly-pct-purchase') / 100;
            const appreciation = getVal('int-home-appreciation') / 100;
            const endTermPct = getVal('int-end-term-pct') / 100;
            const endTermExpensesAbs = getVal('int-end-term-expenses-abs');
            const sellingCostsPct = getVal('int-selling-costs-pct') / 100;

            // --- Get Renter Inputs ---
            let currentRent = getVal('int-yearly-rent');
            const rentIncrease = getVal('int-rent-increase') / 100;
            const rentAdditionalYearlyExpensesAbs = getVal('int-rent-additional-yearly-expenses-abs');

            // --- Get Investment Inputs ---
            const initialPortfolioValueBuyer = getVal('int-initial-portfolio-value-buyer');
            const initialPortfolioValueRenter = getVal('int-initial-portfolio-value-renter');

            const investmentDuringFixedTerm = getVal('int-purchase-yearly-investment');
            const investmentAfterFixedTerm = getVal('int-purchase-yearly-investment-after');
            const buyerInvestmentIncrease = getVal('int-purchase-yearly-investment-increase') / 100;
            
            let currentYearlyInvestmentRenter = getVal('int-rental-yearly-investment');
            const yearlyInvestmentIncreaseRenter = getVal('int-rental-yearly-investment-increase') / 100;

            // --- Initial State (Year 0) ---
            let ownerInvestmentPortfolio = initialPortfolioValueBuyer;
            let ownerPortfolioBasis = initialPortfolioValueBuyer;
            let renterInvestmentPortfolio = initialPortfolioValueRenter;
            let renterPortfolioBasis = initialPortfolioValueRenter;

            // --- Simulation Setup (Tracking Variables) ---
            let currentHomeValue = homePrice;
            let currentAdditionalYearlyExpensesPurchaseAbs = additionalYearlyExpensesBuyerAbs; 
            let currentRentAdditionalYearlyExpensesAbs = rentAdditionalYearlyExpensesAbs; 
            let currentInvestmentDuring = investmentDuringFixedTerm;
            let currentInvestmentAfter = investmentAfterFixedTerm;
            
            // --- Expense Tracking (Cumulative) ---
            let ownerCumulativeExpenses = initialBuyingExpenses; // Starts with initial costs
            let renterCumulativeExpenses = 0;
            
            // --- Separate Breakdown Accumulators (New) ---
            let totalOwnerFixedCosts = 0;
            let totalOwnerAdditionalCosts = 0;
            let totalEndTermCosts = 0;
            let totalRentPaid = 0;
            let totalRenterAdditionalCosts = 0;

            // --- Breakeven Tracking ---
            let breakevenYear = null;

            // --- Simulation ---
            let ownerNetWorthHistory = [];
            let renterNetWorthHistory = [];
            let ownerExpenseHistory = [];
            let renterExpenseHistory = [];
            let yearByYearData = []; 

            // --- Year 0 Initial State ---
            const initialOwnerNetWorth = currentHomeValue + ownerInvestmentPortfolio;
            ownerNetWorthHistory.push(initialOwnerNetWorth); 
            renterNetWorthHistory.push(renterInvestmentPortfolio);
            ownerExpenseHistory.push(ownerCumulativeExpenses);
            renterExpenseHistory.push(renterCumulativeExpenses);
            
            yearByYearData.push({
                year: 0,
                type: 'Yearly',
                owner: {
                    costs: { fixed: 0, additionalAbsolute: 0, additionalPercent: 0, total: 0 },
                    investment: { deposit: 0, totalPortfolio: ownerInvestmentPortfolio },
                    homeValue: currentHomeValue,
                    netWorth: initialOwnerNetWorth,
                    cashOut: 0 
                },
                renter: {
                    costs: { rent: 0, additionalAbsolute: 0, total: 0 },
                    investment: { deposit: 0, totalPortfolio: renterInvestmentPortfolio },
                    netWorth: renterInvestmentPortfolio,
                    cashOut: 0 
                }
            });


            for (let year = 1; year <= years; year++) {
                // --- 1. Calculate EOY Home Value ---
                currentHomeValue = currentHomeValue * (1 + appreciation);

                // --- 2. Owner Simulation ---
                const yearlyFixed = (year <= fixedTermYears) ? fixedTermAbs : 0;
                const additionalPercentCostPurchase = currentHomeValue * additionalYearlyPctPurchase;
                const yearlyAdditionalPurchase = currentAdditionalYearlyExpensesPurchaseAbs + additionalPercentCostPurchase;
                const totalOwnerCosts = yearlyFixed + yearlyAdditionalPurchase;
                
                // Update Cumulative Expenses
                ownerCumulativeExpenses += totalOwnerCosts;
                // Update granular totals
                totalOwnerFixedCosts += yearlyFixed;
                totalOwnerAdditionalCosts += yearlyAdditionalPurchase;

                const yearlyOwnerInvestment = (year <= fixedTermYears)
                    ? currentInvestmentDuring
                    : currentInvestmentAfter;
                
                const ownerCashOut = totalOwnerCosts + yearlyOwnerInvestment;


                // --- 3. Renter Simulation ---
                const renterCost = currentRent + currentRentAdditionalYearlyExpensesAbs;
                
                // Update Cumulative Expenses
                renterCumulativeExpenses += renterCost;
                // Update granular totals
                totalRentPaid += currentRent;
                totalRenterAdditionalCosts += currentRentAdditionalYearlyExpensesAbs;
                
                const renterCashOut = renterCost + currentYearlyInvestmentRenter;
                
                // --- 4. Apply Investments & Growth (Pre-Transaction State) ---
                let ownerPortfolioBeforeGrowth = ownerInvestmentPortfolio + yearlyOwnerInvestment;
                let eoyOwnerPortfolio = ownerPortfolioBeforeGrowth * (1 + investmentRate);
                
                let renterPortfolioBeforeGrowth = renterInvestmentPortfolio + currentYearlyInvestmentRenter; 
                let eoyRenterPortfolio = renterPortfolioBeforeGrowth * (1 + investmentRate);

                let eoyOwnerNetWorth = currentHomeValue + eoyOwnerPortfolio;
                const eoyRenterNetWorth = eoyRenterPortfolio;

                // --- Check for Breakeven ---
                if (!breakevenYear && eoyRenterNetWorth >= eoyOwnerNetWorth) {
                    breakevenYear = year;
                }
                
                // --- 5. Apply Fixed-Term Expiration Expenses (If applicable) ---
                let endTermTransactionCost = 0;

                if (year === fixedTermYears && fixedTermYears > 0) {
                    endTermTransactionCost = (currentHomeValue * endTermPct) + endTermExpensesAbs;
                    
                    // Just add to Cumulative Expenses (Sunk Cost tracking).
                    ownerCumulativeExpenses += endTermTransactionCost;
                    totalEndTermCosts += endTermTransactionCost;
                }

                
                // --- 6. Store History & Data for Table ---
                ownerNetWorthHistory.push(eoyOwnerNetWorth); 
                renterNetWorthHistory.push(eoyRenterNetWorth);
                
                ownerExpenseHistory.push(ownerCumulativeExpenses);
                renterExpenseHistory.push(renterCumulativeExpenses);

                yearByYearData.push({
                    year: year,
                    type: 'Yearly',
                    owner: {
                        costs: { 
                            fixed: yearlyFixed, 
                            additionalAbsolute: currentAdditionalYearlyExpensesPurchaseAbs, 
                            additionalPercent: additionalPercentCostPurchase, 
                            total: totalOwnerCosts 
                        },
                        investment: { 
                            deposit: yearlyOwnerInvestment, 
                            totalPortfolio: eoyOwnerPortfolio 
                        },
                        cashOut: ownerCashOut, 
                        homeValue: currentHomeValue, 
                        netWorth: eoyOwnerNetWorth
                    },
                    renter: {
                        costs: { 
                            rent: currentRent, 
                            additionalAbsolute: currentRentAdditionalYearlyExpensesAbs, 
                            total: renterCost 
                        },
                        investment: { 
                            deposit: currentYearlyInvestmentRenter, 
                            totalPortfolio: eoyRenterPortfolio 
                        },
                        cashOut: renterCashOut, 
                        netWorth: eoyRenterNetWorth
                    }
                });

                // REMOVED the EndTermExpense row gap here as requested

                // --- 7. Update tracking variables for NEXT year ---
                ownerInvestmentPortfolio = eoyOwnerPortfolio; 
                renterInvestmentPortfolio = eoyRenterPortfolio; 

                ownerPortfolioBasis += yearlyOwnerInvestment;
                renterPortfolioBasis += currentYearlyInvestmentRenter;
                

                // Inflate costs/investments for next loop
                currentAdditionalYearlyExpensesPurchaseAbs *= (1 + inflation);
                currentInvestmentDuring *= (1 + buyerInvestmentIncrease);
                currentInvestmentAfter *= (1 + buyerInvestmentIncrease);
                currentRent *= (1 + rentIncrease);
                currentRentAdditionalYearlyExpensesAbs *= (1 + inflation);
                currentYearlyInvestmentRenter *= (1 + yearlyInvestmentIncreaseRenter);
            }

            // --- Final Calculations (Post-Simulation Transaction) ---
            
            const finalOwnerHomeValue = currentHomeValue;
            const finalOwnerPortfolio = ownerInvestmentPortfolio;
            const finalRenterPortfolio = renterInvestmentPortfolio;

            // 1. Owner Home Sale Transaction
            const sellingCost = finalOwnerHomeValue * sellingCostsPct;
            
            // Selling cost added to cumulative expenses graph
            ownerCumulativeExpenses += sellingCost;
            // Update final expense history point
            ownerExpenseHistory[years] = ownerCumulativeExpenses;

            // Selling cost NOT deducted from Net Worth
            let homeProceeds = finalOwnerHomeValue; 
            
            
            // 2. Owner Portfolio Liquidation Tax: Applied ONLY to gains
            const ownerPortfolioGains = finalOwnerPortfolio - ownerPortfolioBasis;
            let ownerPortfolioTax = 0;
            if (ownerPortfolioGains > 0) {
                ownerPortfolioTax = ownerPortfolioGains * capGainsTax;
            }
            
            // 3. Renter Portfolio Liquidation Tax: Applied ONLY to gains
            const renterGains = finalRenterPortfolio - renterPortfolioBasis;
            let renterTax = 0;
            if (renterGains > 0) {
                renterTax = renterGains * capGainsTax;
            }
            
            // Calculate final net worths
            const finalOwnerNetWorth = homeProceeds + (finalOwnerPortfolio - ownerPortfolioTax); 
            const finalRenterNetWorth = finalRenterPortfolio - renterTax;

            // Add transaction row for Final Sale/Liquidation
            yearByYearData.push({
                year: years,
                type: 'FinalSale',
                owner: {
                    salePrice: finalOwnerHomeValue,
                    sellingCost: sellingCost,
                    ownerPortfolio: finalOwnerPortfolio,
                    ownerPortfolioBasis: ownerPortfolioBasis, 
                    ownerPortfolioGains: ownerPortfolioGains, 
                    ownerPortfolioTax: ownerPortfolioTax,
                    finalNetWorth: finalOwnerNetWorth
                },
                renter: {
                    portfolio: finalRenterPortfolio,
                    renterPortfolioBasis: renterPortfolioBasis, 
                    renterGains: renterGains, 
                    renterTax: renterTax,
                    finalNetWorth: finalRenterNetWorth
                }
            });

            // Update Net Worth History for final point to reflect sale/tax
            ownerNetWorthHistory[years] = finalOwnerNetWorth;
            renterNetWorthHistory[years] = finalRenterNetWorth;
            
            // Prepare summary data for the bottom panel
            const summaryData = {
                owner: {
                    initial: initialBuyingExpenses,
                    fixed: totalOwnerFixedCosts,
                    additional: totalOwnerAdditionalCosts,
                    endTerm: totalEndTermCosts,
                    selling: sellingCost,
                    total: ownerCumulativeExpenses
                },
                renter: {
                    rent: totalRentPaid,
                    additional: totalRenterAdditionalCosts,
                    total: renterCumulativeExpenses
                }
            };

            return {
                owner: finalOwnerNetWorth,
                renter: finalRenterNetWorth,
                ownerHistory: ownerNetWorthHistory,
                renterHistory: renterNetWorthHistory,
                ownerExpenseHistory: ownerExpenseHistory,
                renterExpenseHistory: renterExpenseHistory,
                yearByYearData: yearByYearData,
                breakevenYear: breakevenYear,
                summaryData: summaryData
            };
        }
        
        // --- Display Functions ---

        /**
         * Renders the results and the chart.
         * @param {object} results - The results object from the calculation.
         * @param {number} years - The analysis period.
         */
        function displayResults(results, years) {
            resultsYears.textContent = years;
            
            const { owner, renter, ownerHistory, renterHistory, ownerExpenseHistory, renterExpenseHistory, yearByYearData, breakevenYear, summaryData } = results;

            ownerNetWorthEl.textContent = formatCurrency(owner);
            renterNetWorthEl.textContent = formatCurrency(renter);
            
            const benefit = Math.abs(owner - renter);
            if (owner > renter) {
                winnerEl.textContent = "Owning";
                netBenefitEl.textContent = formatCurrency(benefit);
                netBenefitEl.classList.add('text-cyan-400');
                netBenefitEl.classList.remove('text-lime-400', 'text-white');
            } else {
                winnerEl.textContent = "Renting";
                netBenefitEl.textContent = formatCurrency(benefit);
                netBenefitEl.classList.add('text-lime-400');
                netBenefitEl.classList.remove('text-cyan-400', 'text-white');
            }

            // --- Display Chart Annotation ---
            const chartAnnotationEl = document.getElementById('chart-annotation-text');
            if (breakevenYear) {
                chartAnnotationEl.textContent = `ðŸ“ˆ At the end of Year ${breakevenYear}, the Renter's Net Worth has equaled or surpassed the Owner's Net Worth.`;
                chartAnnotationEl.classList.remove('hidden');
            } else {
                chartAnnotationEl.textContent = '';
                chartAnnotationEl.classList.add('hidden');
            }
            // --- End Chart Annotation ---


            renderChart(ownerHistory, renterHistory, years);
            renderExpensesChart(ownerExpenseHistory, renterExpenseHistory, years);
            renderTable(yearByYearData, breakevenYear); 
            renderCostSummary(summaryData);
            resultsSection.classList.remove('hidden');
        }

        /**
         * Renders the Cost Summary Panel
         */
        function renderCostSummary(data) {
            const container = document.getElementById('cost-summary-container');
            
            container.innerHTML = `
                <h3 class="text-xl font-semibold text-white mb-4 text-center">Total Sunk Cost Breakdown</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    
                    <!-- Owner Costs -->
                    <div class="bg-gray-900/50 border border-cyan-900 rounded-lg p-4">
                        <h4 class="text-lg font-bold text-cyan-400 border-b border-cyan-800 pb-2 mb-3">OWNER TOTAL EXPENSES</h4>
                        <div class="space-y-3">
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-300">Initial Buying Costs:</span>
                                <span class="text-white font-medium">${formatCurrency(data.owner.initial)}</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-300">Total Fixed Term Exp. (Mortgage etc):</span>
                                <span class="text-white font-medium">${formatCurrency(data.owner.fixed)}</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-300">Total Additional Exp. (Maint/Tax):</span>
                                <span class="text-white font-medium">${formatCurrency(data.owner.additional)}</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-300">End of Term Costs:</span>
                                <span class="text-white font-medium">${formatCurrency(data.owner.endTerm)}</span>
                            </div>
                             <div class="flex justify-between text-sm">
                                <span class="text-gray-300">Selling Costs:</span>
                                <span class="text-white font-medium">${formatCurrency(data.owner.selling)}</span>
                            </div>
                            <div class="border-t border-cyan-800 pt-2 flex justify-between text-lg font-bold mt-2">
                                <span class="text-cyan-400">TOTAL OWNER COST:</span>
                                <span class="text-cyan-400">${formatCurrency(data.owner.total)}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Renter Costs -->
                    <div class="bg-gray-900/50 border border-lime-900 rounded-lg p-4">
                        <h4 class="text-lg font-bold text-lime-400 border-b border-lime-800 pb-2 mb-3">RENTER TOTAL EXPENSES</h4>
                        <div class="space-y-3">
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-300">Total Rent Paid:</span>
                                <span class="text-white font-medium">${formatCurrency(data.renter.rent)}</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-300">Total Additional Expenses:</span>
                                <span class="text-white font-medium">${formatCurrency(data.renter.additional)}</span>
                            </div>
                            <!-- Spacer to align totals if needed -->
                            <div class="h-5 hidden md:block"></div>
                            <div class="h-5 hidden md:block"></div>
                            <div class="h-5 hidden md:block"></div>

                            <div class="border-t border-lime-800 pt-2 flex justify-between text-lg font-bold mt-2">
                                <span class="text-lime-400">TOTAL RENTER COST:</span>
                                <span class="text-lime-400">${formatCurrency(data.renter.total)}</span>
                            </div>
                        </div>
                    </div>
                </div>
                <p class="text-center text-gray-500 text-xs mt-4 italic">Note: These are "sunk costs" (money spent and gone). They do not include principal payments or investments, which are assets.</p>
            `;
        }

        /**
         * Renders the year-by-year data table, including transaction rows.
         * @param {Array} data - The yearByYearData array from calculations.
         * @param {number | null} breakevenYear - The year the renter breaks even.
         */
        function renderTable(data, breakevenYear) { 
            const container = document.getElementById('results-table-container');
            if (!container) return;
            
            const sellingCostsPctForTable = getVal('int-selling-costs-pct'); 
            const endTermPctForTable = getVal('int-end-term-pct');
            const endTermExpensesAbsForTable = getVal('int-end-term-expenses-abs');
            const capGainsTaxForTable = getVal('int-cap-gains-tax');

            let tableHTML = `
                <table class="min-w-full divide-y divide-gray-700">
                    <thead class="bg-gray-800 sticky top-0 z-10">
                        <tr>
                            <th scope="col" class="py-3.5 px-3 text-left text-xs font-semibold text-gray-400 uppercase tracking-wider">Year</th>
                            
                            <th scope="col" class="py-3.5 px-3 text-left text-xs font-semibold text-cyan-400 uppercase tracking-wider">Owner Fixed Exp.</th>
                            <th scope="col" class="py-3.5 px-3 text-left text-xs font-semibold text-cyan-400 uppercase tracking-wider">Owner Addtl. Exp.</th>
                            <th scope="col" class="py-3.5 px-3 text-left text-xs font-semibold text-cyan-400 uppercase tracking-wider">Owner Total Exp.</th>
                            <th scope="col" class="py-3.5 px-3 text-left text-xs font-semibold text-cyan-400 uppercase tracking-wider">Owner Cash Out</th> 
                            <th scope="col" class="py-3.5 px-3 text-left text-xs font-semibold text-cyan-400 uppercase tracking-wider">Owner Investment</th>
                            <th scope="col" class="py-3.5 px-3 text-left text-xs font-semibold text-cyan-400 uppercase tracking-wider">Owner Portfolio</th>
                            <th scope="col" class="py-3.5 px-3 text-left text-xs font-semibold text-cyan-400 uppercase tracking-wider">Home Value</th>
                            <th scope="col" class="py-3.5 px-3 text-left text-xs font-semibold text-cyan-400 uppercase tracking-wider">Owner Net Worth</th>
                            
                            <th scope="col" class="py-3.5 px-3 text-left text-xs font-semibold text-lime-400 uppercase tracking-wider">Renter Rent</th>
                            <th scope="col" class="py-3.5 px-3 text-left text-xs font-semibold text-lime-400 uppercase tracking-wider">Renter Addtl. Exp.</th>
                            <th scope="col" class="py-3.5 px-3 text-left text-xs font-semibold text-lime-400 uppercase tracking-wider">Renter Total Exp.</th>
                            <th scope="col" class="py-3.5 px-3 text-left text-xs font-semibold text-lime-400 uppercase tracking-wider">Renter Cash Out</th> 
                            <th scope="col" class="py-3.5 px-3 text-left text-xs font-semibold text-lime-400 uppercase tracking-wider">Renter Investment</th>
                            
                            <th scope="col" class="py-3.5 px-3 text-left text-xs font-semibold text-lime-400 uppercase tracking-wider">Renter Portfolio</th>
                            <th scope="col" class="py-3.5 px-3 text-left text-xs font-semibold text-lime-400 uppercase tracking-wider">Renter Net Worth</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-700 bg-gray-900">
            `;

            // Loop through data and build table rows
            data.forEach(yearData => {
                const year = yearData.year;
                
                // Note: EndTermExpense block removed from here as requested.
                
                if (yearData.type === 'FinalSale') {
                    const o = yearData.owner;
                    const r = yearData.renter;
                    
                    tableHTML += `
                        <tr class="bg-gray-700 border-t-4 border-white">
                            <td colspan="16" class="py-4 px-3 text-sm text-center">
                                <span class="font-bold text-xl text-white block mb-4">YEAR ${year} FINAL SALE & PORTFOLIO LIQUIDATION</span>
                            </td>
                        </tr>
                        <tr class="bg-gray-700">
                            <td class="whitespace-nowrap py-4 px-3 text-sm font-bold text-cyan-300"></td>
                            <td colspan="8" class="py-4 px-3 text-sm font-semibold text-gray-400 text-right"> FINAL HOME VALUE (Added to Net Worth):</td>
                            <td class="whitespace-nowrap py-4 px-3 text-sm font-bold text-cyan-400">${formatCurrency(o.salePrice)}</td>
                            
                            <td class="whitespace-nowrap py-4 px-3 text-sm font-bold text-lime-300"></td>
                            <td colspan="4" class="py-4 px-3 text-sm font-semibold text-gray-400 text-right"> RENTER PORTFOLIO VALUE (Before Tax):</td>
                            <td class="whitespace-nowrap py-4 px-3 text-sm font-bold text-lime-400">${formatCurrency(r.portfolio)}</td>
                        </tr>
                        <tr class="bg-gray-700">
                            <td class="whitespace-nowrap py-4 px-3 text-sm font-bold text-cyan-300"></td>
                            <td colspan="8" class="py-4 px-3 text-sm font-semibold text-gray-400 text-right"></td>
                            <td class="whitespace-nowrap py-4 px-3 text-sm font-bold text-red-400"></td>

                            <td class="whitespace-nowrap py-4 px-3 text-sm font-bold text-lime-300"></td>
                            <td colspan="4" class="py-4 px-3 text-sm font-semibold text-gray-400 text-right"> RENTER PORTFOLIO BASIS:</td>
                            <td class="whitespace-nowrap py-4 px-3 text-sm font-bold text-lime-400">${formatCurrency(r.renterPortfolioBasis)}</td>
                        </tr>
                        <tr class="bg-gray-700">
                            <td class="whitespace-nowrap py-4 px-3 text-sm font-bold text-cyan-300"></td>
                            <td colspan="8" class="py-4 px-3 text-sm font-semibold text-gray-400 text-right"> OWNER PORTFOLIO VALUE (Before Tax):</td>
                            <td class="whitespace-nowrap py-4 px-3 text-sm font-bold text-cyan-400">${formatCurrency(o.ownerPortfolio)}</td>
                            
                            <td class="whitespace-nowrap py-4 px-3 text-sm font-bold text-lime-300"></td>
                            <td colspan="4" class="py-4 px-3 text-sm font-semibold text-gray-400 text-right"> RENTER PORTFOLIO GAINS:</td>
                            <td class="whitespace-nowrap py-4 px-3 text-sm font-bold text-lime-400">${formatCurrency(r.renterGains)}</td>
                        </tr>
                        <tr class="bg-gray-700">
                            <td class="whitespace-nowrap py-4 px-3 text-sm font-bold text-cyan-300"></td>
                            <td colspan="8" class="py-4 px-3 text-sm font-semibold text-gray-400 text-right"> OWNER PORTFOLIO BASIS:</td>
                            <td class="whitespace-nowrap py-4 px-3 text-sm font-bold text-cyan-400">${formatCurrency(o.ownerPortfolioBasis)}</td>
                            
                            <td class="whitespace-nowrap py-4 px-3 text-sm font-bold text-lime-300"></td>
                            <td colspan="4" class="py-4 px-3 text-sm font-semibold text-gray-400 text-right"> CAPITAL GAINS TAX (${capGainsTaxForTable.toFixed(1)}% of Gains):</td>
                            <td class="whitespace-nowrap py-4 px-3 text-sm font-bold text-red-400">-${formatCurrency(r.renterTax)}</td>
                        </tr>
                         <tr class="bg-gray-700">
                            <td class="whitespace-nowrap py-4 px-3 text-sm font-bold text-cyan-300"></td>
                            <td colspan="8" class="py-4 px-3 text-sm font-semibold text-gray-400 text-right"> OWNER PORTFOLIO GAINS:</td>
                            <td class="whitespace-nowrap py-4 px-3 text-sm font-bold text-cyan-400">${formatCurrency(o.ownerPortfolioGains)}</td>
                            
                             <td class="whitespace-nowrap py-4 px-3 text-sm font-bold text-lime-300"></td>
                            <td colspan="4" class="py-4 px-3 text-sm font-semibold text-gray-400 text-right"></td>
                            <td class="whitespace-nowrap py-4 px-3 text-sm font-bold text-lime-400"></td>
                        </tr>
                         <tr class="bg-gray-700">
                            <td class="whitespace-nowrap py-4 px-3 text-sm font-bold text-cyan-300"></td>
                            <td colspan="8" class="py-4 px-3 text-sm font-semibold text-gray-400 text-right"> CAPITAL GAINS TAX (${capGainsTaxForTable.toFixed(1)}% of Gains):</td>
                            <td class="whitespace-nowrap py-4 px-3 text-sm font-bold text-red-400">-${formatCurrency(o.ownerPortfolioTax)}</td>
                            
                             <td class="whitespace-nowrap py-4 px-3 text-sm font-bold text-lime-300"></td>
                            <td colspan="4" class="py-4 px-3 text-sm font-semibold text-gray-400 text-right"></td>
                            <td class="whitespace-nowrap py-4 px-3 text-sm font-bold text-lime-400"></td>
                        </tr>
                        <tr class="bg-gray-700 border-b-4 border-cyan-500 border-lime-500">
                            <td class="whitespace-nowrap py-4 px-3 text-sm font-bold text-white"></td>
                            <td colspan="8" class="py-4 px-3 text-lg font-bold text-white text-right"> FINAL OWNER NET WORTH:</td>
                            <td class="whitespace-nowrap py-4 px-3 text-lg font-bold text-cyan-400">${formatCurrency(o.finalNetWorth)}</td>
                            
                            <td class="whitespace-nowrap py-4 px-3 text-sm font-bold text-white"></td>
                            <td colspan="4" class="py-4 px-3 text-lg font-bold text-white text-right"> FINAL RENTER NET WORTH:</td>
                            <td class="whitespace-nowrap py-4 px-3 text-lg font-bold text-lime-400">${formatCurrency(r.finalNetWorth)}</td>
                        </tr>
                    `;
                } else { // Yearly Data Row
                    const o = yearData.owner;
                    const r = yearData.renter;

                    // Standard Year Row
                    tableHTML += `
                        <tr class="hover:bg-gray-700/50 ${year === breakevenYear ? 'border-t-2 border-lime-500' : ''}">
                            <td class="whitespace-nowrap py-4 px-3 text-sm font-bold ${year === 0 ? 'text-white' : 'text-gray-300'}">${year}</td>
                            
                            <td class="whitespace-nowrap py-4 px-3 text-sm text-cyan-300">${formatCurrency(o.costs.fixed)}</td>
                            <td class="whitespace-nowrap py-4 px-3 text-sm text-cyan-300">${formatCurrency(o.costs.additionalAbsolute + o.costs.additionalPercent)}</td>
                            <td class="whitespace-nowrap py-4 px-3 text-sm text-cyan-300">${formatCurrency(o.costs.total)}</td>
                            <td class="whitespace-nowrap py-4 px-3 text-sm font-bold text-cyan-500">${formatCurrency(o.cashOut)}</td> <td class="whitespace-nowrap py-4 px-3 text-sm font-medium text-cyan-400">${formatCurrency(o.investment.deposit)}</td>
                            <td class="whitespace-nowrap py-4 px-3 text-sm font-bold text-cyan-400">${formatCurrency(o.investment.totalPortfolio)}</td>
                            <td class="whitespace-nowrap py-4 px-3 text-sm text-cyan-400">${formatCurrency(o.homeValue)}</td>
                            <td class="whitespace-nowrap py-4 px-3 text-sm font-bold text-cyan-400">${formatCurrency(o.netWorth)}</td>

                            <td class="whitespace-nowrap py-4 px-3 text-sm text-lime-300">${formatCurrency(r.costs.rent)}</td>
                            <td class="whitespace-nowrap py-4 px-3 text-sm text-lime-300">${formatCurrency(r.costs.additionalAbsolute)}</td>
                            <td class="whitespace-nowrap py-4 px-3 text-sm text-lime-300">${formatCurrency(r.costs.total)}</td>
                            <td class="whitespace-nowrap py-4 px-3 text-sm font-bold text-lime-500">${formatCurrency(r.cashOut)}</td> <td class="whitespace-nowrap py-4 px-3 text-sm font-medium text-lime-400">${formatCurrency(r.investment.deposit)}</td>
                            
                            <td class="whitespace-nowrap py-4 px-3 text-sm font-bold text-lime-400">${formatCurrency(r.investment.totalPortfolio)}</td>
                            <td class="whitespace-nowrap py-4 px-3 text-sm font-bold text-lime-400">${formatCurrency(r.netWorth)}</td>
                        </tr>
                    `;
                }
                
                // Breakeven Row Insertion
                if (breakevenYear && year === breakevenYear) {
                    tableHTML += `
                        <tr class="bg-lime-900/50 border-t-2 border-lime-500 border-b-2 border-lime-500">
                            <td colspan="16" class="py-3 px-3 text-lg font-bold text-center text-lime-300">
                                ðŸŸ¢ AT THE END OF YEAR ${year}, THE RENTER'S NET WORTH HAS EQUALED OR SURPASSED THE OWNER'S NET WORTH.
                            </td>
                        </tr>
                    `;
                }
                
            });
            tableHTML += ` </tbody> </table> `;
            container.innerHTML = tableHTML;
        }

        /**
         * Renders the line chart using Chart.js.
         */
        function renderChart(ownerHistory, renterHistory, years) {
            const labels = Array.from({ length: years + 1 }, (_, i) => i);

            if (myChart) {
                myChart.destroy();
            }

            myChart = new Chart(chartCanvas, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Owner Net Worth',
                            data: ownerHistory,
                            borderColor: 'rgb(45, 212, 191)', // cyan-400
                            backgroundColor: 'rgba(45, 212, 191, 0.1)',
                            fill: false,
                            tension: 0.1,
                            pointRadius: 3,
                            pointHoverRadius: 6
                        },
                        {
                            label: 'Renter Net Worth',
                            data: renterHistory,
                            borderColor: 'rgb(163, 230, 53)', // lime-400
                            backgroundColor: 'rgba(163, 230, 53, 0.1)',
                            fill: false,
                            tension: 0.1,
                            pointRadius: 3,
                            pointHoverRadius: 6
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                },
                                color: '#d1d5db', // gray-300
                            },
                            grid: {
                                color: '#4b5563' // gray-600
                            }
                        },
                        x: {
                            ticks: {
                                color: '#d1d5db', // gray-300
                            },
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#d1d5db' 
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += formatCurrency(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        /**
         * Renders the Expenses line chart using Chart.js.
         */
        function renderExpensesChart(ownerExpenses, renterExpenses, years) {
            const labels = Array.from({ length: years + 1 }, (_, i) => i);

            if (myExpensesChart) {
                myExpensesChart.destroy();
            }

            myExpensesChart = new Chart(expensesChartCanvas, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Owner Cumulative Expenses (Sunk)',
                            data: ownerExpenses,
                            borderColor: 'rgb(248, 113, 113)', // red-400
                            backgroundColor: 'rgba(248, 113, 113, 0.1)',
                            fill: true,
                            tension: 0.1,
                            pointRadius: 2,
                            pointHoverRadius: 5
                        },
                        {
                            label: 'Renter Cumulative Expenses (Sunk)',
                            data: renterExpenses,
                            borderColor: 'rgb(250, 204, 21)', // yellow-400
                            backgroundColor: 'rgba(250, 204, 21, 0.1)',
                            fill: true,
                            tension: 0.1,
                            pointRadius: 2,
                            pointHoverRadius: 5
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Total Spent to Date',
                                color: '#9ca3af'
                            },
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                },
                                color: '#d1d5db', 
                            },
                            grid: {
                                color: '#4b5563' 
                            }
                        },
                        x: {
                            ticks: {
                                color: '#d1d5db', 
                            },
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#d1d5db' 
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += formatCurrency(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

    </script>
</body>
</html>
